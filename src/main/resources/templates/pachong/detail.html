<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>爬虫插入/修改页面</title>
</head>
<body>
<!--详情/更新页-->
<div th:if="${pachong!=null}">
    详情/更新页
    <form action="/detail/save">
        <label>id:</label><input id="id" name="id" th:value="${pachong.id}" type="hidden"/><br>
        <label>url:</label><textarea th:name="url" th:text="${pachong.url}"></textarea><br>
        <label>method:</label><input th:name="method" th:value="${pachong.method}"/><br>
        <label>请求头:</label><textarea th:name="headers" th:text="${pachong.headers}"></textarea><br>
        <label>代理IP文件地址:</label><input name="proxyFilePath" th:value="${pachong.proxyFilePath}"/><br>
        <label>委托方:</label><input name="weituofang" th:value="${pachong.weituofang}"/><br>
        <label>响应类型:</label><input name="responseType" th:value="${pachong.responseType}"/><br>
        <label>保存方式:</label><input name="saveType" th:value="${pachong.saveType}"/><br>
        <label>抓取单元:</label><input class="extractUnit" name="extractUnit" th:value="${pachong.extractUnit}"
                                   type="hidden"/><br>
        <div class="points">
            <div class="extract-point">
                <label>名称:</label><input class="name" type="text"></input>
                <label>选择器语法:</label><textarea class="selector" type="text"></textarea>
                <label>提取属性名称:</label><input class="attrName" type="text" width="200px"></input>
                <button class="add-btn" onclick="addPoint();return false;">继续添加</button>
                <button class="remove-btn" onclick="removePoint(this);return false;">删除</button>
            </div>
        </div>
        <a id="execute-btn" th:href=@{'/detail/execute?id='+${pachong['id']}}>执行爬虫</a>
        <input onclick="preSave();" type="submit" value="保存"/>
        <br>
    </form>
</div>

<!--插入页面-->
<div th:if="${pachong==null}">
    插入页面
    <form action="/detail/save" class="save-form">
        <label>url:</label><textarea name="url"></textarea><br>
        <label>method:</label><input name="method"/><br>
        <label>请求头:</label><textarea name="method"></textarea><br>
        <label>代理文件地址:</label><input name="proxyFilePath"/><br>
        <label>委托方:</label><input name="weituofang"/><br>
        <label>响应类型:</label><input name="responseType"/><br>
        <label>保存方式:</label><input name="saveType"/><br>
        <label>抓取单元:</label><input class="extractUnit" name="extractUnit" type="hidden"></input><br>
        <div class="points">
            <div class="extract-point">
                <label>名称:</label><input class="name" type="text"></input>
                <label>选择器语法:</label><textarea class="selector" type="text"></textarea>
                <label>提取属性名称:</label><input class="attrName" type="text" width="200px"></input>
                <button class="add-btn" onclick="addPoint();return false;">继续添加</button>
                <button class="remove-btn" onclick="removePoint(this);return false;">删除</button>
            </div>
        </div>
        <input onclick="preSave();" type="submit" value="保存"/>
        <br>
    </form>
</div>
<script type="text/javascript">
    let extractUnitNode = document.getElementsByClassName("extractUnit")[0];
    let extractUnit = extractUnitNode.value;
    if (extractUnit != "") {
        let unitJson = JSON.parse(extractUnit);
        let points = unitJson['points'];
        console.log(points);
        for (let i = 0; i < points.length; i++) {
            if (i != points.length - 1) {
                let cloeNode = document.getElementsByClassName("extract-point")[0].cloneNode(true);
                document.getElementsByClassName("points")[0].appendChild(cloeNode);
            }
            let extract_point = document.getElementsByClassName("extract-point")[i];

            extract_point.getElementsByClassName("name")[0].value = points[i]["name"];
            extract_point.getElementsByClassName("selector")[0].value = points[i]["selector"];
            extract_point.getElementsByClassName("attrName")[0].value = points[i]["attrName"];
        }

    }

    function preSave() {
        let extract_points = document.getElementsByClassName("extract-point");
        let points = [];
        for (let i = 0; i < extract_points.length; i++) {
            let point = document.getElementsByClassName("extract-point")[i];
            let name = point.getElementsByClassName("name")[0].value;
            let selector = point.getElementsByClassName("selector")[0].value;
            let attrName = point.getElementsByClassName("attrName")[0].value;
            var pointJson = {
                name: name,
                selector: selector,
                attrName: attrName
            };
            points[i] = pointJson;
        }

        var extractUnit = {
            points: points
        };
        console.log(JSON.stringify(extractUnit));
        let unit = document.getElementsByClassName("extractUnit")[0];
        unit.value = JSON.stringify(extractUnit);

    }

    function addPoint() {
        let unitsEle = document.getElementsByClassName("points")[0];
        let unit_clone = document.getElementsByClassName("extract-point")[0].cloneNode(true);
        unitsEle.appendChild(unit_clone);
    }

    function removePoint(self) {
        self.parentNode.parentNode.removeChild(self.parentNode);
    }

</script>
</body>
</html>